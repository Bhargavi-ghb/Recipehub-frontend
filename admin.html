<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>RecipeHub Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    /* General Body and Layout */
    body {
      display: flex;
      min-height: 100vh;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f9fafb;
      color: #333;
    }

    /* Sidebar Styling */
    .sidebar {
      width: 250px;
      background-color: #00796b;
      color: white;
      padding: 25px 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      box-shadow: 3px 0 10px rgba(0, 0, 0, 0.1);
    }

    .sidebar h3 {
      font-weight: 700;
      margin-bottom: 30px;
      font-size: 1.6rem;
      letter-spacing: 1.2px;
      text-align: center;
      text-transform: uppercase;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .sidebar button {
      margin: 10px 0;
      width: 100%;
      font-weight: 600;
      text-transform: uppercase;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    .sidebar button:hover {
      background-color: #004d40;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      color: #fff;
    }

    .sidebar .btn-danger {
      margin-top: auto;
      background-color: #d32f2f;
      border-color: #d32f2f;
      font-weight: 700;
    }

    .sidebar .btn-danger:hover {
      background-color: #9a2424;
      border-color: #9a2424;
    }

    /* Content area */
    .content {
      flex-grow: 1;
      padding: 30px 40px;
      background-color: #fff;
      box-sizing: border-box;
      overflow-y: auto;
      max-height: 100vh;
      box-shadow: inset 0 0 15px #f0f0f0;
    }

    /* Header Titles */
    .content h2 {
      font-weight: 700;
      color: #00796b;
      margin-bottom: 20px;
      letter-spacing: 0.8px;
    }

    /* Search User Input */
    #searchUser {
      margin-bottom: 20px;
      border-radius: 8px;
      border: 1px solid #ccc;
      padding: 8px 12px;
      font-size: 1rem;
      transition: box-shadow 0.3s ease;
    }

    #searchUser:focus {
      outline: none;
      box-shadow: 0 0 8px #00796b;
      border-color: #00796b;
    }

    /* User List Items */
    #userList li {
      font-size: 1rem;
      font-weight: 500;
      border-radius: 8px;
      margin-bottom: 8px;
      transition: background-color 0.3s ease;
      padding: 12px 15px;
      cursor: default;
    }

    #userList li:hover {
      background-color: #e0f2f1;
    }

    /* Card container grid */
    .row-cols-md-3>.col {
      margin-bottom: 1.6rem;
    }

    /* Recipe Cards */
    .card {
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      background-color: #fafafa;
      display: flex;
      flex-direction: column;
    }

    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.18);
      background-color: #ffffff;
    }

    .card-img-top {
      width: 100%;
      height: 250px;
      object-fit: cover;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      background-color: #e0e0e0;
      transition: filter 0.3s ease;
    }

    .card-img-top:hover {
      filter: brightness(1.05);
    }

    .card-body {
      padding: 18px 20px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 12px;
      color: #004d40;
    }

    .card-text {
      flex-grow: 1;
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 12px;
      min-height: 60px;
      /* consistent height */
    }

    .card span {
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 15px;
      display: inline-block;
    }

    /* Buttons inside cards */
    .card-body>div button {
      min-width: 90px;
      font-weight: 600;
      border-radius: 6px;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    .card-body>div button:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-sm {
      padding: 0.375rem 0.7rem;
      font-size: 0.8rem;
    }

    /* Loading Spinner Container */
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }

    .recipe-author {
      font-size: 0.9rem;
      font-style: italic;
      color: #555;
      /* soft gray for subtle look */
      margin-top: 5px;
      font-weight: bold;
    }

    .recipe-author strong {
      color: #008080;
      /* matches your teal theme */
      font-weight: bold;
    }

    /* Responsive tweak for small screens */
    @media (max-width: 576px) {
      .sidebar {
        width: 100%;
        flex-direction: row;
        padding: 15px 10px;
        overflow-x: auto;
        box-shadow: none;
      }

      .sidebar h3 {
        flex: 1 0 auto;
        margin-bottom: 0;
        font-size: 1.3rem;
        text-align: left;
      }

      .sidebar button {
        margin: 0 5px;
        flex: 0 0 auto;
        white-space: nowrap;
      }

      body {
        flex-direction: column;
      }

      .content {
        padding: 20px 15px;
        max-height: none;
      }
    }
  </style>
</head>

<body>
  <div class="sidebar">
    <h3>Admin Panel</h3>
    <button class="btn btn-light" onclick="showDashboard()">Dashboard</button>
    <button class="btn btn-light" onclick="showUsers()">Users</button>
    <button class="btn btn-light" onclick="showPending()">Pending Recipes</button>
    <button class="btn btn-light" onclick="showAllRecipes()">All Recipes</button>
    <button class="btn btn-light" onclick="showRejected()">Rejected Recipes</button>
    <button class="btn btn-danger mt-auto" onclick="logout()">Logout</button>
  </div>

  <div class="content" id="content-area">
    <h2>Welcome Admin</h2>
    <p>Select a section from the left.</p>
  </div>

  <script>
    if (localStorage.getItem("isAdmin") !== "true") {
      alert("Access denied. Admins only.");
      window.location.href = "/login.html";
    }
    let currentView = 'welcome';

    function getLoadingSpinner() {
      return `
        <div class="d-flex justify-content-center align-items-center" style="height: 100px;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>`;
    }

    function getRecipeCard(recipe, status, buttonsHtml = '') {
      const color = status === "Approved" ? "#2e7d32" : status === "Rejected" ? "#c62828" : "#ef6c00";
      const imgSrc = recipe.image_url && recipe.image_url.trim() !== "" ? recipe.image_url : 'https://via.placeholder.com/300x150?text=No+Image';
      return `
        <div class="col">
          <div class="card h-100 shadow-sm">
            <img src="${imgSrc}" class="card-img-top" alt="${recipe.title}">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">${recipe.title}</h5>
              <p class="recipe-author"><strong>By:</strong> ${recipe.user?.name || "Unknown"}</p>
              <p class="card-text flex-grow-1">${recipe.description.substring(0, 100)}${recipe.description.length > 100 ? '...' : ''}</p>
              <span class="mb-3 align-self-start" style="color: ${color};">${status}</span>
              <div>${buttonsHtml}</div>
            </div>
          </div>
        </div>`;
    }

    function showDashboard() {
      currentView = 'dashboard';
      document.getElementById("content-area").innerHTML = getLoadingSpinner();

      Promise.all([
        fetch('https://recipehub-backend-1.onrender.com/Users/count').then(res => res.json()),
        fetch('https://recipehub-backend-1.onrender.com/Recipes/count').then(res => res.json()),
        fetch('https://recipehub-backend-1.onrender.com/Recipes/getRecipes').then(res => res.json())
      ])
        .then(([userCount, recipeCount, recipes]) => {
          const quickRecipes = recipes.filter(r => {
            const prep = parseInt(r.prep_time) || 0;
            const cook = parseInt(r.cook_time) || 0;
            return (prep + cook) < 30;
          });

          let quickRecipesHtml = '';
          if (quickRecipes.length === 0) {
            quickRecipesHtml = '<p>No recipes under 30 minutes found.</p>';
          } else {
            quickRecipesHtml = `<div class="row row-cols-1 row-cols-md-3 g-4">`;
            quickRecipes.forEach(recipe => {
              const prep = parseInt(recipe.prep_time) || 0;
              const cook = parseInt(recipe.cook_time) || 0;
              const totalTime = prep + cook;

              const imgSrc = recipe.image_url && recipe.image_url.trim() !== "" ? recipe.image_url : 'https://via.placeholder.com/300x150?text=No+Image';

              quickRecipesHtml += `
              <div class="col">
                <div class="card h-100 shadow-sm">
                  <img src="${imgSrc}" class="card-img-top" alt="${recipe.title}">
                  <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${recipe.title}</h5>
                    <p class="recipe-author"><strong>By:</strong> ${recipe.user?.name || "Unknown"}</p>
                    <p class="card-text flex-grow-1">${recipe.description.substring(0, 70)}${recipe.description.length > 70 ? '...' : ''}</p>
                    <p><small><strong>Total Time:</strong> ${totalTime} minutes</small></p>
                  </div>
                </div>
              </div>
            `;
            });
            quickRecipesHtml += `</div>`;
          }

          document.getElementById("content-area").innerHTML = `
          <h2>Dashboard</h2>
          <p><strong>Total Users:</strong> ${userCount}</p>
          <p><strong>Total Recipes:</strong> ${recipeCount}</p>
          <p><strong>Recipes under 30 minutes:</strong> ${quickRecipes.length}</p>
          <hr />
          <h3>Quick Recipes (Under 30 mins)</h3>
          ${quickRecipesHtml}
        `;
        })
        .catch(error => {
          document.getElementById("content-area").innerHTML = `<p class="text-danger">Error loading dashboard data.</p>`;
          console.error("Dashboard error:", error);
        });
    }

    function showUsers() {
      currentView = 'users';
      document.getElementById("content-area").innerHTML = getLoadingSpinner();

      fetch('https://recipehub-backend-1.onrender.com/Users/getuser')
        .then(res => res.json())
        .then(users => {
          if (users.length === 0) {
            document.getElementById("content-area").innerHTML = `<h2>All Users</h2><p>No users found.</p>`;
            return;
          }

          let html = `
            <h2>All Users</h2>
            <input class="form-control" type="text" id="searchUser" placeholder="Search user by name or email" onkeyup="filterUsers()" />
            <ul class="list-group" id="userList">
          `;

          users.forEach(user => {
            html += `
              <li class="list-group-item d-flex justify-content-between align-items-center">
                ${user.name} (${user.email})
                <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">Delete</button>
              </li>`;
          });
          html += `</ul>`;
          document.getElementById("content-area").innerHTML = html;
        })
        .catch(error => {
          document.getElementById("content-area").innerHTML = `<p class="text-danger">Error loading users.</p>`;
          console.error("Users error:", error);
        });
    }

    function filterUsers() {
      const input = document.getElementById("searchUser").value.toLowerCase();
      const items = document.querySelectorAll("#userList li");
      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(input) ? "" : "none";
      });
    }

    function deleteUser(id) {
      if (confirm("Are you sure you want to delete this user?")) {
        fetch(`https://recipehub-backend-1.onrender.com/Users/delete/${id}`, { method: 'DELETE' })
          .then(response => {
            if (!response.ok) throw new Error('Network response was not OK');
            return response.json().catch(() => { });
          })
          .then(() => showUsers())
          .catch(error => {
            alert("Failed to delete user");
            console.error("Delete user error:", error);
          });
      }
    }

    function showPending() {
      currentView = 'pending';
      document.getElementById("content-area").innerHTML = getLoadingSpinner();

      fetch('https://recipehub-backend-1.onrender.com/Recipes/pending')
        .then(res => res.json())
        .then(recipes => {
          if (recipes.length === 0) {
            document.getElementById("content-area").innerHTML = `<h2>Pending Recipes</h2><p>No pending recipes found.</p>`;
            return;
          }

          let html = `<h2>Pending Recipes</h2><div class="row row-cols-1 row-cols-md-3 g-4">`;
          recipes.forEach(recipe => {
            html += getRecipeCard(
              recipe,
              "Pending",
              `
                <div>
                  <button class="btn btn-success btn-sm me-2" onclick="approveRecipe(${recipe.id})">Approve</button>
                  <button class="btn btn-danger btn-sm" onclick="rejectRecipe(${recipe.id})">Reject</button>
                </div>
              `
            );
          });
          html += `</div>`;
          document.getElementById("content-area").innerHTML = html;
        })
        .catch(error => {
          document.getElementById("content-area").innerHTML = `<p class="text-danger">Error loading pending recipes.</p>`;
          console.error("Pending recipes error:", error);
        });
    }

    function showAllRecipes() {
      currentView = 'allRecipes';
      document.getElementById("content-area").innerHTML = getLoadingSpinner();

      fetch('https://recipehub-backend-1.onrender.com/Recipes/getRecipes')
        .then(res => res.json())
        .then(recipes => {
          recipes = recipes.filter(recipe => recipe.approved === true);

          if (recipes.length === 0) {
            document.getElementById("content-area").innerHTML = `<h2>All Recipes</h2><p>No approved recipes found.</p>`;
            return;
          }

          let html = `<h2>All Recipes</h2><div class="row row-cols-1 row-cols-md-3 g-4">`;
          recipes.forEach(recipe => {
            html += getRecipeCard(
              recipe,
              "Approved",
              `<button class="btn btn-warning btn-sm" onclick="deleteRecipe(${recipe.id})">Delete</button>`
            );
          });
          html += `</div>`;
          document.getElementById("content-area").innerHTML = html;
        })
        .catch(error => {
          document.getElementById("content-area").innerHTML = `<p class="text-danger">Error loading recipes.</p>`;
          console.error("All recipes error:", error);
        });
    }

    function showRejected() {
      currentView = 'rejected';
      document.getElementById("content-area").innerHTML = getLoadingSpinner();

      fetch('https://recipehub-backend-1.onrender.com/Recipes/getRecipes')
        .then(res => res.json())
        .then(recipes => {
          const rejectedRecipes = recipes.filter(recipe => recipe.approved === false);

          if (rejectedRecipes.length === 0) {
            document.getElementById("content-area").innerHTML = `<h2>Rejected Recipes</h2><p>No rejected recipes found.</p>`;
            return;
          }

          let html = `<h2>Rejected Recipes</h2><div class="row row-cols-1 row-cols-md-3 g-4">`;
          rejectedRecipes.forEach(recipe => {
            html += getRecipeCard(
              recipe,
              "Rejected",
              `<button class="btn btn-warning btn-sm" onclick="deleteRecipe(${recipe.id})">Delete</button>`
            );
          });
          html += `</div>`;
          document.getElementById("content-area").innerHTML = html;
        })
        .catch(error => {
          document.getElementById("content-area").innerHTML = `<p class="text-danger">Error loading rejected recipes.</p>`;
          console.error("Rejected recipes error:", error);
        });
    }

    function approveRecipe(id) {
      fetch(`https://recipehub-backend-1.onrender.com/Recipes/approve/${id}`, { method: 'PUT' })
        .then(res => {
          if (!res.ok) throw new Error('Failed to approve');
          return res.json().catch(() => { });
        })
        .then(() => {
          alert("Recipe approved");
          showPending();
        })
        .catch(error => {
          alert("Error approving recipe");
          console.error("Approve error:", error);
        });
    }

    function rejectRecipe(id) {
      fetch(`https://recipehub-backend-1.onrender.com/Recipes/reject/${id}`, {
        method: 'PUT'
      })
        .then(res => {
          if (!res.ok) throw new Error('Failed to reject');
          return res.json().catch(() => { });
        })
        .then(() => {
          alert("Recipe rejected");
          showPending();
        })
        .catch(error => {
          alert("Error rejecting recipe");
          console.error("Reject error:", error);
        });
    }

    function deleteRecipe(id) {
      if (confirm("Are you sure you want to delete this recipe?")) {
        fetch(`https://recipehub-backend-1.onrender.com/Recipes/delete/reject/${id}`, { method: 'DELETE' })
          .then(res => {
            if (!res.ok) throw new Error('Failed to delete');
            return res.json().catch(() => { });
          })
          .then(() => {
            alert("Recipe deleted");
            if (currentView === 'allRecipes') showAllRecipes();
            else if (currentView === 'rejected') showRejected();
            else if (currentView === 'pending') showPending();
          })
          .catch(error => {
            alert("Error deleting recipe");
            console.error("Delete error:", error);
          });
      }
    }

    function logout() {
      // You can add actual logout logic here
      alert("Logged out successfully.");
      location.reload();
      window.location.href = "/login.html";
    }
  </script>


</body>

</html>